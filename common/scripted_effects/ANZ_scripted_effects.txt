#一场酝酿已久的内战
ANZ_let_be_final_civil_war = {
	news_event = { id = anz_news.1 }
	country_lock_all_division_template = no
	#处理什么国策都没点的懒狗
	if = { 
		limit = { NOT = { has_country_flag = ANZ_ANZIO } NOT = { has_country_flag = ANZ_LOTHIAN } }
		set_country_flag = ANZ_ANZIO
		#给你加点料
		add_to_variable = {
			anz_civil_enemy_power = 10
		}
	}
	
	#安齐奥
	if = {
		limit = { has_country_flag = ANZ_ANZIO }
		#乌斯拉尔援助
		if = {
			limit = { 
				NOT = { has_idea = ANZ_USR_support }
				check_variable = {
					ANZ.anz_fascism_tension > 4
				} 
			}
			add_timed_idea = {
				idea = ANZ_USR_support
				days = 365
			}
		}
		for_loop_effect = {
			end = anz_temp
			add_equipment_to_stockpile = {
				type = infantry_equipment_1
				amount = 1000
				producer = USR
			}
			add_equipment_to_stockpile = {
				type = artillery_equipment_1
				amount = 300
				producer = USR
			}
		}
		#转换中立将
		every_unit_leader = {
			limit = { NOT = { has_trait = ANZ_scuola_industriale } NOT = { has_trait = ANZ_fazione_di_mana } }
			#每有一个敌对将领，对面都会多俩师
			ANZ = {
				add_to_variable = {
					anz_civil_enemy_power = 1
				}
			}
			add_trait = {
				trait = ANZ_fazione_di_mana
			}
		}
		#内战分兵调整
		set_variable = {
			anz_civil_ratio = 0.5
		}
		if = {  
			limit = { ANZ = { is_ai = no } }
			add_to_variable = {
				anz_civil_ratio = 0.25
			}
		}
		#内战具体设置
		start_civil_war = {
			ideology = democratic
			size = 0.5
			#ai玩家区分修改
			army_ratio = anz_civil_ratio
    		navy_ratio = 0
			keep_unit_leaders_trigger = {
				has_trait = ANZ_scuola_industriale
			}
			#keep_all_characters = no
			#有bug！还是会出现对方将领在我们这边，直接丢掉
			PREV = { 
				every_unit_leader = {
					limit = { has_trait = ANZ_fazione_di_mana }
					retire = yes
				}
			}
			states = { 251 239 227 237 220 223 }
			#为ai调整难度
			if = {
				limit = { PREV = { is_ai = yes } }
				add_ideas = ANZ_hidden_weaken_civil
			}
			
			#保存动态国家TAG
			set_variable = { PREV.anz_civil_revolter_tag = THIS }
			#处理敌人难度增加师
			if = { 
				limit = { PREV = { is_ai = no } }
				while_loop_effect = {
					limit = { check_variable = {
						ANZ.anz_civil_enemy_power > 0
					} }
					add_to_variable = {
						ANZ.anz_civil_enemy_power = -1
					}
					237 = {
						create_unit = {
							division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
							owner = THIS.owner
						}
						create_unit = {
							division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
							owner = THIS.owner
						}
					}
				}
			}
			set_country_flag = ANZ_LOTHIAN
			#副领导人切换
			if = {
				limit = { ANZ = { has_idea = ANZ_another_leader_Giovanna } }
				ANZ = { 
					ANZ_retire_vice_country_leader = yes
					add_ideas = ANZ_another_leader_Adriana
				}
			}
			set_variable = {
				another_country_leader_group = 3
			}
			add_ideas = ANZ_another_leader_Giovanna
			
		}
		#处理内战双方军队难度
		if = {
			limit = {
				is_ai = yes
			}
			var:anz_civil_revolter_tag = {
				add_ideas = ANZ_hidden_weaken_civil
			}
		}
		else = {
			#为玩家增加常规内战难度
			while_loop_effect = {
				limit = { check_variable = {
					ANZ.anz_civil_enemy_power > 0
				} }
				add_to_variable = {
					ANZ.anz_civil_enemy_power = -1
				}
				var:anz_civil_revolter_tag = {
					205 = {
						create_unit = {
							division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
							owner = THIS.owner
						}
						create_unit = {
							division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
							owner = THIS.owner
						}
					}
					#洛蒂安需要删除所有装甲部队模板
					delete_unit_template_and_units = {
						division_template = "Anzio Panzer Division"
					}
				}
			}
		}
		#安齐奥需要删除所有魔法部队模板
		delete_unit_template_and_units = {
			division_template = "Lottian Arcane Platton"
		}
		#我方增加部队
		while_loop_effect = {
			limit = { check_variable = {
				ANZ.anz_civil_our_power > 0
			} }
			#如果是ai的话多给个师稍微发门炮
			if = {
				limit = { ROOT = { is_ai = yes } }
				add_to_variable = {
					ANZ.anz_civil_our_power = -1
				}
				add_equipment_to_stockpile = {
					type = artillery_equipment_1
					amount = 20
				}
			}
			else = {
				add_to_variable = {
					ANZ.anz_civil_our_power = -2
				}
			}
			
			205 = {
				#如果是笨比ai的话给个炮
				if = {
					limit = { ROOT = { is_ai = yes } }
					create_unit = {
						division = "name = \"Lottian Infantry Division Upriser\" division_template = \"Lottian Infantry Division Upriser\" start_experience_factor = 0.3"
						owner = THIS.owner
					}
				}
				else = {
					create_unit = {
						division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
						owner = THIS.owner
					}
				}
			}
		}
	}
	#洛蒂安
	else_if = {
		limit = { has_country_flag = ANZ_LOTHIAN }
		#转换中立将
		every_unit_leader = {
			limit = { NOT = { has_trait = ANZ_scuola_industriale } NOT = { has_trait = ANZ_fazione_di_mana } }
			#每有一个敌对将领，对面都会多俩师
			ANZ = {
				add_to_variable = {
					anz_civil_enemy_power = 1
				}
			}
			add_trait = {
				trait = ANZ_scuola_industriale
			}
		}
		start_civil_war = {
			ruling_party = democratic
			ideology = ROOT
			size = 0.5
			army_ratio = anz_civil_ratio
    		navy_ratio = 1
			keep_unit_leaders_trigger = {
				has_trait = ANZ_fazione_di_mana
			}
			#keep_all_characters = no
			#有bug！还是会出现对方将领在我们这边，直接丢掉
			PREV = { 
				every_unit_leader = {
					limit = { has_trait = ANZ_scuola_industriale }
					retire = yes
				}
			}
			states = { 180 203 176 193 171 170 188 223 205 207 210 }
			#保存动态国家TAG
			set_variable = { PREV.anz_civil_revolter_tag = THIS }

			set_country_flag = ANZ_ANZIO
			#副领导人切换
			if = { 
				limit = { ANZ = { has_idea = ANZ_another_leader_Adriana } }
				ANZ = {
					ANZ_retire_vice_country_leader = yes
					add_ideas = ANZ_another_leader_Carla
				}
			}
			set_variable = {
				another_country_leader_group = 3
			}
			add_ideas = ANZ_another_leader_Adriana
		}
		#处理内战双方军队难度
		if = {
			limit = {
				is_ai = yes
			}
			var:anz_civil_revolter_tag = {
				add_ideas = ANZ_hidden_weaken_civil
			}
		}
		else = {
			#为玩家增加常规内战难度
			while_loop_effect = {
				limit = { check_variable = {
					ANZ.anz_civil_enemy_power > 0
				} }
				add_to_variable = {
					ANZ.anz_civil_enemy_power = -1
				}
				var:anz_civil_revolter_tag = {
					205 = {
						create_unit = {
							division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
							owner = THIS.owner
						}
						create_unit = {
							division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
							owner = THIS.owner
						}
					}
					#安齐奥需要删除所有魔法部队模板
					delete_unit_template_and_units = {
						division_template = "Lottian Arcane Platton"
					}
				}
			}
		}
		#洛蒂安需要删除所有装甲部队模板
		delete_unit_template_and_units = {
			division_template = "Anzio Panzer Division"
		}
		#我方增加部队
		while_loop_effect = {
			limit = { check_variable = {
				ANZ.anz_civil_our_power > 0
			} }
			#如果是ai的话多给个师
			if = {
				limit = { ROOT = { is_ai = yes } }
				add_to_variable = {
					ANZ.anz_civil_our_power = -1
				}
			}
			else = {
				add_to_variable = {
					ANZ.anz_civil_our_power = -2
				}
			}
			
			205 = {
				#如果是笨比ai的话给个炮
				if = {
					limit = { ROOT = { is_ai = yes } }
					create_unit = {
						division = "name = \"Lottian Infantry Division Upriser\" division_template = \"Lottian Infantry Division Upriser\" start_experience_factor = 0.3"
						owner = THIS.owner
					}
				}
				else = {
					create_unit = {
						division = "name = \"Lottian Infantry Division\" division_template = \"Lottian Infantry Division\" start_experience_factor = 0.15"
						owner = THIS.owner
					}
				}
			}
		}
		if = {
			limit = { has_completed_focus = ANZ_the_blood_crusades }
			load_oob = "ANZ_crusader"
		}
		if = {
			limit = { has_completed_focus = ANZ_icorporation_of_diocese_of_aldrich }
			246 = { transfer_state_to = ANZ }
			228 = { transfer_state_to = ANZ }
			216 = { transfer_state_to = ANZ }
			236 = { transfer_state_to = ANZ }
			246 = { add_core_of = ANZ }
			228 = { add_core_of = ANZ }
			216 = { add_core_of = ANZ }
			236 = { add_core_of = ANZ }
		}
	}
	#关闭BOP
	remove_power_balance = {
		id = ANZ_industrialization_against_manalisation
	}
	custom_effect_tooltip = ANZ_tooltip22
	hidden_effect = {
		#按照标签读取国策
		if = {
			limit = { has_country_flag = ANZ_ANZIO }
			load_focus_tree = ANZ_anzio
		}
		else = {
			load_focus_tree = ANZ_lothian
		}
	}
}

#移除副领导人
ANZ_retire_vice_country_leader = {
	if = {
		limit = { has_idea = ANZ_another_leader_Adriana }
		remove_ideas = ANZ_another_leader_Adriana
	}
	if = {
		limit = { has_idea = ANZ_another_leader_Giovanna }
		remove_ideas = ANZ_another_leader_Giovanna
	}
	if = {
		limit = { has_idea = ANZ_another_leader_Carla }
		remove_ideas = ANZ_another_leader_Carla
	}
}