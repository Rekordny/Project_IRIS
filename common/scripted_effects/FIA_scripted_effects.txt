#初始化主战角色池
FIA_character_1_Array_setup = {
    FIA = {
        clear_array = FIA_character_1_Array
        add_to_array = {FIA_character_1_Array = token:FIA_Avaro}
        add_to_array = {FIA_character_1_Array = token:FIA_Fia}
        add_to_array = {FIA_character_1_Array = token:FIA_Kisnil}
        add_to_array = {FIA_character_1_Array = token:FIA_Iol}
        add_to_array = {FIA_character_1_Array = token:FIA_Micheju}
        add_to_array = {FIA_character_1_Array = token:FIA_Mikschana}
        add_to_array = {FIA_character_1_Array = token:FIA_Deet}
        add_to_array = {FIA_character_1_Array = token:FIA_Katlit}
        add_to_array = {FIA_character_1_Array = token:FIA_Roselyne}
        add_to_array = {FIA_character_1_Array = token:FIA_Lishenntser}
        remove_from_array = {FIA_character_1_Array = FIA_character_selection_1}
        remove_from_array = {FIA_character_1_Array = FIA_character_selection_2}
    }
}
#初始化辅助角色池
FIA_character_2_Array_setup = {
    FIA = {
        clear_array = FIA_character_2_Array
        add_to_array = {FIA_character_2_Array = token:FIA_Avaro}
        add_to_array = {FIA_character_2_Array = token:FIA_Fia}
        add_to_array = {FIA_character_2_Array = token:FIA_Kisnil}
        add_to_array = {FIA_character_2_Array = token:FIA_Iol}
        add_to_array = {FIA_character_2_Array = token:FIA_Micheju}
        add_to_array = {FIA_character_2_Array = token:FIA_Mikschana}
        add_to_array = {FIA_character_2_Array = token:FIA_Deet}
        add_to_array = {FIA_character_2_Array = token:FIA_Katlit}
        add_to_array = {FIA_character_2_Array = token:FIA_Roselyne}
        add_to_array = {FIA_character_2_Array = token:FIA_Lishenntser}
        remove_from_array = {FIA_character_2_Array = FIA_character_selection_1}
        remove_from_array = {FIA_character_2_Array = FIA_character_selection_2}
    }
}
#加载技能
FIA_skill_Array_setup = {
    FIA = {
        clear_array = FIA_skill_Array
        add_to_array = {FIA_skill_Array = token:FIA_Attack_1}#物理攻击
        add_to_array = {FIA_skill_Array = token:FIA_Defence}#物理防御
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_1 = token:FIA_Fia}
                    check_variable = {FIA_character_selection_1 = token:FIA_Micheju}
                    check_variable = {FIA_character_selection_1 = token:FIA_Roselyne}
                    check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
                }
            }
            add_to_array = {FIA_skill_Array = token:FIA_Attack_2}#法师技能
        }
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
                    check_variable = {FIA_character_selection_1 = token:FIA_Kisnil}
                    check_variable = {FIA_character_selection_1 = token:FIA_Iol}
                    check_variable = {FIA_character_selection_1 = token:FIA_Lishenntser}
                    check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
                    check_variable = {FIA_character_selection_1 = token:FIA_Deet}
                    check_variable = {FIA_character_selection_1 = token:FIA_Katlit}
                }
            }
            add_to_array = {FIA_skill_Array = token:FIA_Attack_3}#物理技能
        }
        if = {
            limit = {
                OR = {
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
                        check_variable = {FIA_character_selection_2 = token:FIA_Fia}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Fia}
                        check_variable = {FIA_character_selection_2 = token:FIA_Avaro}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Iol}
                        check_variable = {FIA_character_selection_2 = token:FIA_Micheju}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Micheju}
                        check_variable = {FIA_character_selection_2 = token:FIA_Iol}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
                        check_variable = {FIA_character_selection_2 = token:FIA_Kisnil}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Kisnil}
                        check_variable = {FIA_character_selection_2 = token:FIA_Mikschana}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
                        check_variable = {FIA_character_selection_2 = token:FIA_Deet}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Deet}
                        check_variable = {FIA_character_selection_2 = token:FIA_Avaro}
                    }
                    check_variable = {FIA_character_selection_2 = token:FIA_Katlit}
                }
            }
            add_to_array = {FIA_skill_Array = token:FIA_Attack_special}#连携技能
        }
    }
}
#战斗设定
FIA_battle_setup = {
    FIA = {
        clear_array = FIA_RPG_GAME_record_Array
        clear_array = FIA_RPG_GAME_record_Array_2 #数据记录用数组

        set_variable = {FIA_RPG_round = 1}
        set_variable = {FIA_RPG_character_action = 0}
        set_variable = {FIA_RPG_enemy_action = 0}
        set_variable = {FIA_Attack_special_cooldown = 0}
        set_variable = {FIA_character_1_special_var = 0}

        add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_RPG_log_round} 
        set_temp_variable = {FIA_RPG_round_temp = FIA_RPG_round}
        add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_round_temp}
        
        clr_country_flag = FIA_RPG_character_move_first
        clr_country_flag = FIA_RPG_enemy_move_first
        clr_country_flag = FIA_enemy_has_moved
        clr_country_flag = FIA_RPG_our_turn
        #检测速度决定先攻
        if = {
            limit = {
                check_variable = {FIA_RPG_enemy_1_SPEED > FIA_RPG_character_1_SPEED}
            }
            set_country_flag = FIA_RPG_enemy_move_first
            FIA_enemy_move_effect = yes
        }
        else_if = {
            limit = {
                check_variable = {var = FIA_RPG_character_1_SPEED value = FIA_RPG_enemy_1_SPEED compare = equals}
            }
            random_list = {
                50 = {
                    set_country_flag = FIA_RPG_enemy_move_first
                    FIA_enemy_move_effect = yes
                }
                50 = {
                    set_country_flag = FIA_RPG_character_move_first
                    set_country_flag = FIA_RPG_our_turn
                }
            }
        }
        else = {
            set_country_flag = FIA_RPG_character_move_first
            set_country_flag = FIA_RPG_our_turn
        }

        #辅助技能设定
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_2 = token:FIA_Avaro}
                    check_variable = {FIA_character_selection_2 = token:FIA_Lishenntser}
                    check_variable = {FIA_character_selection_2 = token:FIA_Kisnil}
                }
            }
            set_variable = {FIA_character_2_skill = 1} #援护防御
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_2 = token:FIA_Micheju}
            }
            set_variable = {FIA_character_2_skill = 2} #反射
        }
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_2 = token:FIA_Fia}
                    check_variable = {FIA_character_selection_2 = token:FIA_Roselyne}
                }
            }
            set_variable = {FIA_character_2_skill = 3} #治愈
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_2 = token:FIA_Iol}
            }
            set_variable = {FIA_character_2_skill = 4} #反击
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_2 = token:FIA_Deet}
            }
            set_variable = {FIA_character_2_skill = 5} #援护射击
        }
        else = {
            set_variable = {FIA_character_2_skill = 0}
        }

        #种族设定
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
            }
            set_variable = {FIA_character_1_race_var = 1} #半精灵
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Fia}
            }
            set_variable = {FIA_character_1_race_var = 2} #现神
        }
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_1 = token:FIA_Kisnil}
                    check_variable = {FIA_character_selection_1 = token:FIA_Roselyne}
                    check_variable = {FIA_character_selection_1 = token:FIA_Deet}
                    check_variable = {FIA_character_selection_1 = token:FIA_Lishenntser}
                }
            }
            set_variable = {FIA_character_1_race_var = 3} #人类
        }
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_1 = token:FIA_Iol}
                    check_variable = {FIA_character_selection_1 = token:FIA_Micheju}
                }
            }
            set_variable = {FIA_character_1_race_var = 4} #兽人
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
            }
            set_variable = {FIA_character_1_race_var = 5} #天使
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Katlit}
            }
            set_variable = {FIA_character_1_race_var = 6} #龙
        }
        else = {
            set_variable = {FIA_character_1_race_var = 0}
        }


        #加成设定
        if = {
            limit = {
                OR = {
                    check_variable = {FIA_character_selection_1 = token:FIA_Fia}
                    check_variable = {FIA_character_selection_1 = token:FIA_Deet}
                }
            }
            set_variable = {FIA_character_1_special_var = 1} #对空迎击
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Iol}
            }
            set_variable = {FIA_character_1_special_var = 2} #人类杀
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Roselyne}
            }
            set_variable = {FIA_character_1_special_var = 3} #死灵破坏&精灵杀
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
            }
            set_variable = {FIA_character_1_special_var = 4} #恶魔杀
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Lishenntser}
            }
            set_variable = {FIA_character_1_special_var = 5} #幻兽杀
        }
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
            }
            set_variable = {FIA_character_1_special_var = 6} #创造破坏
        }
        else = {
            set_variable = {FIA_character_1_special_var = 0}
        }

    }
}
#检测回合结束
FIA_check_if_end_turn = {
    FIA = {
        if = {
            limit = {
                check_variable = {var = FIA_RPG_character_action value = FIA_RPG_enemy_action compare = equals}
                NOT = { has_country_flag = FIA_RPG_round_processed } # 保证一回合只处理一次
            }
            set_country_flag = FIA_RPG_round_processed
            add_to_variable = {FIA_RPG_round = 1}
            add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_RPG_log_round} 
            set_temp_variable = {FIA_RPG_round_temp = FIA_RPG_round}
            add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_round_temp}
            clr_country_flag = FIA_enemy_has_moved
            if = {
                limit = {
                    check_variable = {FIA_Attack_special_cooldown > 0}
                }
                add_to_variable = {FIA_Attack_special_cooldown = -1}
            }
            if = {
                limit = {
                    has_country_flag = FIA_RPG_enemy_move_first
                }
                FIA_enemy_move_effect = yes
            }
            else = {
                set_country_flag = FIA_RPG_our_turn
            }
        }

        # 如果敌人先手但还没行动，就先让敌人行动
        else_if = {
            limit = {
                has_country_flag = FIA_RPG_enemy_move_first
                NOT = { has_country_flag = FIA_enemy_has_moved }
            }
            FIA_enemy_move_effect = yes
        }

        # 如果敌人行动过了，我方行动还没开始，则进入我方回合
        else_if = {
            limit = {
                has_country_flag = FIA_RPG_enemy_move_first
                has_country_flag = FIA_enemy_has_moved
                NOT = { has_country_flag = FIA_RPG_our_turn }
            }
            set_country_flag = FIA_RPG_our_turn
        }
    }
}
#我方角色行动
FIA_character_move_effect = {
    clr_country_flag = FIA_RPG_round_processed
    if = {
        limit = {
            has_country_flag = FIA_RPG_character_1_def
        }
        set_variable = {FIA_RPG_character_1_DEF_1 = FIA_RPG_character_1_DEF_1_o}
        set_variable = {FIA_RPG_character_1_DEF_2 = FIA_RPG_character_1_DEF_2_o}
        clr_country_flag = FIA_RPG_character_1_def
    }
    meta_effect = {
        text = {
            [ACTION]_effect = yes
        }
        ACTION = "[?v.GetTokenKey]"
        #FIA_Attack_1
        #FIA_Defence
        #FIA_Attack_2 
        #FIA_Attack_3
        #FIA_Attack_special
    }
}
FIA_set_damage_to_random_effect = {
    FIA = {
        set_variable_to_random = {
            var = FIA_RPG_damage_random_multiplier
            min = 0.75
            max = 1.25
            integer = no
        }
        multiply_variable = {
            FIA_RPG_character_damage = FIA_RPG_damage_random_multiplier
        }
        round_variable = FIA_RPG_character_damage
    }
}
FIA_set_enemy_damage_to_random_effect = {
    FIA = {
        set_variable_to_random = {
            var = FIA_RPG_damage_random_multiplier
            min = 0.9
            max = 1.4
            integer = no
        }
        multiply_variable = {
            FIA_RPG_enemy_damage = FIA_RPG_damage_random_multiplier
        }
        round_variable = FIA_RPG_enemy_damage
    }
}
#攻击结算
FIA_character_damage_effect = {
    FIA = {
        if = {
            limit = {
                NOT = {has_country_flag = FIA_RPG_character_1_def}
            }
            meta_effect = {
                text = {
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_damage_[VAR]}
                }
                VAR = "[?FIA_character_damage_var]"
            }
            if = {
                limit = {
                    FIA_character_1_special_trigger = yes
                }
                multiply_variable = {FIA_RPG_character_damage = 1.5} #种族加成
                round_variable = FIA_RPG_character_damage
            }
            set_temp_variable = {FIA_RPG_character_damage_temp = FIA_RPG_character_damage}
            add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_character_damage_temp}#存入伤害记录数组

            subtract_from_variable = {FIA_RPG_enemy_1_HP = FIA_RPG_character_damage}
        }
        
        if = {
            limit = {
                check_variable = {FIA_RPG_enemy_1_HP < 1}
            }
            FIA_win_battle_effect = yes
        }
        else_if = {
            limit = {
                has_country_flag = FIA_RPG_enemy_move_first
            }
            FIA_check_if_end_turn = yes
        }
        else = {
            FIA_enemy_move_effect = yes
        }
    }
}
#敌方攻击结算
FIA_enemy_damage_effect = {
    FIA = {
        meta_effect = {
            text = {
                add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_enemy_damage_[VAR]}
            }
            VAR = "[?FIA_enemy_damage_var]"
        }
        if = {
            limit = {
                FIA_enemy_1_special_trigger = yes
            }
            multiply_variable = {FIA_RPG_enemy_damage = 1.5} #种族加成
            round_variable = FIA_RPG_enemy_damage
        }
        set_temp_variable = {FIA_RPG_enemy_damage_temp = FIA_RPG_enemy_damage}
        add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_enemy_damage_temp}#存入伤害记录数组

        subtract_from_variable = {FIA_RPG_character_1_HP = FIA_RPG_enemy_damage}
        clr_country_flag = FIA_RPG_round_processed
        if  = {
            limit = {
                check_variable = {FIA_RPG_character_1_HP < 1}
            }
            FIA_lose_battle_effect = yes
        }
        else = {
            FIA_character_2_skill_effect_2 = yes
        }
    }
}
FIA_refresh_character_1_data_effect = {
    FIA = {
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_HP = [CHARACTER_1]_MAX_HP}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_MAX_HP = [CHARACTER_1]_MAX_HP}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_ATK_1 = [CHARACTER_1]_ATK_1}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_ATK_2 = [CHARACTER_1]_ATK_2}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_DEF_1 = [CHARACTER_1]_DEF_1}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_DEF_2 = [CHARACTER_1]_DEF_2}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_SPEED = [CHARACTER_1]_SPEED}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_LV = [CHARACTER_1]_LV}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_LV = [CHARACTER_1]_XP}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
        meta_effect = {
            text = {
                set_variable = {FIA_RPG_character_1_LV = [CHARACTER_1]_XP_required}
            }
            CHARACTER_1 = "[?FIA_character_selection_1.GetTokenKey]"
        }
    }
}
#胜利结算
FIA_win_battle_effect = {
    FIA = {
        clr_country_flag = FIA_is_in_battle
        clr_country_flag = FIA_RPG_selection_confirmed
        add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_RPG_log_win}
        add_to_array = {FIA_RPG_GAME_record_Array_2 = 0}
        FIA_refresh_character_1_data_effect = yes
        set_temp_variable = {FIA_character_to_gain_XP = FIA_character_selection_1}
        FIA_gain_XP_effect = yes
        if = {
            limit = {
                NOT = {check_variable = {FIA_character_selection_2 = 0}}
            }
            set_temp_variable = {FIA_sub_character_to_gain_XP = FIA_character_selection_2}
            FIA_gain_XP_sub_effect = yes
        }
    }
}
#失败结算
FIA_lose_battle_effect = {
    FIA = {
        clr_country_flag = FIA_is_in_battle
        clr_country_flag = FIA_RPG_selection_confirmed
        add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_RPG_log_lose}
    }
}
#普通攻击效果
FIA_Attack_1_effect = {
    FIA = {
        set_variable = {FIA_RPG_character_damage = 0}
        set_variable = {FIA_RPG_enemy_1_DEF_1_t = FIA_RPG_enemy_1_DEF_1}
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
            }
            random_list = {
                30 = {
                    multiply_variable = {FIA_RPG_enemy_1_DEF_1_t = 0.5}
                    round_variable = FIA_RPG_enemy_1_DEF_1_t
                }
                70 = {}
            }
        }
        if = {
            limit = {
                check_variable = {var = FIA_RPG_character_1_ATK_1 value = FIA_RPG_enemy_1_DEF_1_t compare = less_than_or_equals}
            }
            set_variable = {FIA_RPG_character_damage = 1} #保底伤害
        }
        else = {
            set_variable = {FIA_RPG_character_damage = FIA_RPG_character_1_ATK_1}
            subtract_from_variable = {FIA_RPG_character_damage = FIA_RPG_enemy_1_DEF_1_t}
        }
        FIA_set_damage_to_random_effect = yes#0.75-1.25随机化，取整
        clr_country_flag = FIA_RPG_our_turn
        random_list = {
            #5%暴击率
            5 = {
                multiply_variable = {FIA_RPG_character_damage = 2}
                round_variable = FIA_RPG_character_damage
                set_variable = {FIA_character_damage_var = 5}
            }
            95 = {
                set_variable = {FIA_character_damage_var = 1}
            }
        }
        
        add_to_variable = {FIA_RPG_character_action = 1} #一定要先加上行动，再执行攻击
        FIA_enemy_2_skill_effect_1 = yes
        #FIA_character_damage_effect = yes #执行攻击
    }
}
#魔法攻击效果
FIA_Attack_2_effect = {
    FIA = {
        set_variable = {FIA_RPG_character_damage = 0}
        set_variable = {FIA_RPG_character_1_ATK_2_t = FIA_RPG_character_1_ATK_2}
        multiply_variable = {FIA_RPG_character_1_ATK_2_t = 1.5} #魔法技能威力为基础1.5倍
        round_variable = FIA_RPG_character_1_ATK_2_t
        if = {
            limit = {
                check_variable = {var = FIA_RPG_character_1_ATK_2_t value = FIA_RPG_enemy_1_DEF_2 compare = less_than_or_equals}
            }
            set_variable = {FIA_RPG_character_damage = 1} #保底伤害
        }
        else = {
            set_variable = {FIA_RPG_character_damage = FIA_RPG_character_1_ATK_2_t}
            subtract_from_variable = {FIA_RPG_character_damage = FIA_RPG_enemy_1_DEF_2}
        }
        FIA_set_damage_to_random_effect = yes#0.75-1.25随机化，取整
        clr_country_flag = FIA_RPG_our_turn
        random_list = {
            #5%暴击率
            5 = {
                multiply_variable = {FIA_RPG_character_damage = 2}
                round_variable = FIA_RPG_character_damage
                set_variable = {FIA_character_damage_var = 6}
                
            }
            95 = {
                set_variable = {FIA_character_damage_var = 2}
            }
        }

        add_to_variable = {FIA_RPG_character_action = 1}
        FIA_character_damage_effect = yes #执行攻击
    }
}
#物理技能攻击效果
FIA_Attack_3_effect = {
    FIA = {
        set_variable = {FIA_RPG_character_damage = 0}
        set_variable = {FIA_RPG_character_1_ATK_1_t = FIA_RPG_character_1_ATK_1}
        multiply_variable = {FIA_RPG_character_1_ATK_1_t = 1.3} #物理技能威力为基础1.3倍
        round_variable = FIA_RPG_character_1_ATK_1_t
        set_variable = {FIA_RPG_enemy_1_DEF_1_t = FIA_RPG_enemy_1_DEF_1}
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
            }
            random_list = {
                30 = {
                    multiply_variable = {FIA_RPG_enemy_1_DEF_1_t = 0.5}
                    round_variable = FIA_RPG_enemy_1_DEF_1_t
                }
                70 = {}
            }
        }
        if = {
            limit = {
                check_variable = {var = FIA_RPG_character_1_ATK_1_t value = FIA_RPG_enemy_1_DEF_1_t compare = less_than_or_equals}
            }
            set_variable = {FIA_RPG_character_damage = 1} #保底伤害
        }
        else = {
            set_variable = {FIA_RPG_character_damage = FIA_RPG_character_1_ATK_1_t}
            subtract_from_variable = {FIA_RPG_character_damage = FIA_RPG_enemy_1_DEF_1_t}
        }
        FIA_set_damage_to_random_effect = yes#0.75-1.25随机化，取整
        clr_country_flag = FIA_RPG_our_turn
        random_list = {
            #5%暴击率
            5 = {
                multiply_variable = {FIA_RPG_character_damage = 2}
                round_variable = FIA_RPG_character_damage
                set_variable = {FIA_character_damage_var = 7}
            }
            95 = {
                set_variable = {FIA_character_damage_var = 3}
            }
        }

        add_to_variable = {FIA_RPG_character_action = 1}
        FIA_enemy_2_skill_effect_1 = yes
        #FIA_character_damage_effect = yes #执行攻击
    }
}
#连携技能效果
FIA_Attack_special_effect = {
    FIA = {
        set_variable = {FIA_RPG_character_damage = 0}
        #物理连携技能
        if = {
            limit = {
                OR = {
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
                        check_variable = {FIA_character_selection_2 = token:FIA_Fia}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Iol}
                        check_variable = {FIA_character_selection_2 = token:FIA_Micheju}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
                        check_variable = {FIA_character_selection_2 = token:FIA_Kisnil}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Kisnil}
                        check_variable = {FIA_character_selection_2 = token:FIA_Mikschana}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Avaro}
                        check_variable = {FIA_character_selection_2 = token:FIA_Deet}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Deet}
                        check_variable = {FIA_character_selection_2 = token:FIA_Avaro}
                    }
                }
            }
            set_variable = {FIA_RPG_character_1_ATK_1_t = FIA_RPG_character_1_ATK_1}
            multiply_variable = {FIA_RPG_character_1_ATK_1_t = 2} #物理连携威力为基础2倍
            round_variable = FIA_RPG_character_1_ATK_1_t
            set_variable = {FIA_RPG_enemy_1_DEF_1_t = FIA_RPG_enemy_1_DEF_1}
            if = {
                limit = {
                    check_variable = {FIA_character_selection_1 = token:FIA_Mikschana}
                }
                random_list = {
                    30 = {
                        multiply_variable = {FIA_RPG_enemy_1_DEF_1_t = 0.5}
                        round_variable = FIA_RPG_enemy_1_DEF_1_t
                    }
                    70 = {}
                }
            }
            if = {
                limit = {
                    check_variable = {var = FIA_RPG_character_1_ATK_1_t value = FIA_RPG_enemy_1_DEF_1_t compare = less_than_or_equals}
                }
                set_variable = {FIA_RPG_character_damage = 1} #保底伤害
            }
            else = {
                set_variable = {FIA_RPG_character_damage = FIA_RPG_character_1_ATK_1_t}
                subtract_from_variable = {FIA_RPG_character_damage = FIA_RPG_enemy_1_DEF_1_t}
            }
        }
        #魔法连携技能
        if = {
            limit = {
                OR = {
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Fia}
                        check_variable = {FIA_character_selection_2 = token:FIA_Avaro}
                    }
                    AND = {
                        check_variable = {FIA_character_selection_1 = token:FIA_Micheju}
                        check_variable = {FIA_character_selection_2 = token:FIA_Iol}
                    }
                    check_variable = {FIA_character_selection_1 = token:FIA_Katlit}
                }
            }
            set_variable = {FIA_RPG_character_damage = 0}
            set_variable = {FIA_RPG_character_1_ATK_2_t = FIA_RPG_character_1_ATK_2}
            multiply_variable = {FIA_RPG_character_1_ATK_2_t = 2.5} #魔法连携技能威力为基础2.5倍
            round_variable = FIA_RPG_character_1_ATK_2_t
            if = {
                limit = {
                    check_variable = {var = FIA_RPG_character_1_ATK_2_t value = FIA_RPG_enemy_1_DEF_2 compare = less_than_or_equals}
                }
                set_variable = {FIA_RPG_character_damage = 1} #保底伤害
            }
            else = {
                set_variable = {FIA_RPG_character_damage = FIA_RPG_character_1_ATK_2_t}
                subtract_from_variable = {FIA_RPG_character_damage = FIA_RPG_enemy_1_DEF_2}
            }
        }
        set_variable = {FIA_Attack_special_cooldown = 3}
        clr_country_flag = FIA_RPG_our_turn
        FIA_set_damage_to_random_effect = yes#0.75-1.25随机化，取整
        random_list = {
            #5%暴击率
            5 = {
                multiply_variable = {FIA_RPG_character_damage = 2}
                round_variable = FIA_RPG_character_damage
                set_variable = {FIA_character_damage_var = 8}
                
            }
            95 = {
                set_variable = {FIA_character_damage_var = 4}
            }
        }

        add_to_variable = {FIA_RPG_character_action = 1}
        FIA_character_damage_effect = yes #执行攻击
    }
}
#防御效果
FIA_Defence_effect = {
    FIA = {
        set_variable = {FIA_RPG_character_damage = 0}
        set_variable = {FIA_RPG_character_1_DEF_1_o = FIA_RPG_character_1_DEF_1} #保存原始数据
        set_variable = {FIA_RPG_character_1_DEF_2_o = FIA_RPG_character_1_DEF_2}
        if = {
            limit = {
                check_variable = {FIA_character_selection_1 = token:FIA_Lishenntser}
            }
            multiply_variable = {FIA_RPG_character_1_DEF_1 = 2}
            multiply_variable = {FIA_RPG_character_1_DEF_2 = 2}
            round_variable = FIA_RPG_character_1_DEF_1
            round_variable = FIA_RPG_character_1_DEF_2FIA_RPG_GAME_record_damage_Array
        }
        else = {
            multiply_variable = {FIA_RPG_character_1_DEF_1 = 1.5}
            multiply_variable = {FIA_RPG_character_1_DEF_2 = 1.5}
            round_variable = FIA_RPG_character_1_DEF_1
            round_variable = FIA_RPG_character_1_DEF_2
        }
        if = {
            limit = {
                check_variable = {FIA_RPG_character_1_DEF_1 = 1}
            }
            add_to_variable = {FIA_RPG_character_1_DEF_1 = 1} #保底
        }
        if = {
            limit = {
                check_variable = {FIA_RPG_character_1_DEF_2 = 1}
            }
            add_to_variable = {FIA_RPG_character_1_DEF_2 = 1} #保底
        }
        round_variable = FIA_RPG_character_1_DEF_1
        round_variable = FIA_RPG_character_1_DEF_2
        set_country_flag = FIA_RPG_character_1_def
        clr_country_flag = FIA_RPG_our_turn
        add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_def}
        add_to_array = {FIA_RPG_GAME_record_Array_2 = 0}#存入伤害记录数组
        add_to_variable = {FIA_RPG_character_action = 1}
        FIA_character_damage_effect = yes #执行攻击
    }
}
#敌方攻击执行前检测
FIA_character_2_skill_effect_1 = {
    FIA = {
        if = {
            limit = {
                check_variable = {FIA_character_2_skill = 1} #援护防御
            }
            random_list = {
                20 = {
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_support_1}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = 0}
                    FIA_check_if_end_turn = yes
                }
                80 = {
                    FIA_enemy_damage_effect = yes #敌方攻击
                }
            }
        }
        if = {
            limit = {
                check_variable = {FIA_character_2_skill = 2} #反射 
            }
            random_list = {
                15 = {
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_support_2}
                    set_temp_variable = {FIA_RPG_enemy_damage_temp = FIA_RPG_enemy_damage}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_enemy_damage_temp}

                    subtract_from_variable = {FIA_RPG_enemy_1_HP = FIA_RPG_enemy_damage}
                    if  = {
                        limit = {
                            check_variable = {FIA_RPG_enemy_1_HP < 1}
                        }
                        FIA_win_battle_effect = yes
                    }
                    else = {
                        FIA_enemy_move_effect = yes
                    }
                }
                85 = {
                    FIA_enemy_damage_effect = yes #敌方攻击
                }
            }
        }
        else = {
            FIA_enemy_damage_effect = yes #敌方攻击
        }
    }
}
#敌方攻击执行后检测
FIA_character_2_skill_effect_2 = {
    FIA = {
        if = {
            limit = {
                check_variable = {FIA_character_2_skill = 3} #治愈
            }
            random_list = {
                20 = {
                    set_variable = {FIA_character_2_heal = FIA_RPG_character_2_ATK_2}
                    multiply_variable = {FIA_character_2_heal = 2}
                    add_to_variable = {FIA_RPG_character_1_HP = FIA_character_2_heal}
                    round_variable = FIA_RPG_character_1_HP
                    clamp_variable = {
                        var = FIA_RPG_character_1_HP
                        max = FIA_RPG_character_1_MAX_HP
                    }

                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_support_3}
                    set_temp_variable = {FIA_character_2_heal_temp = FIA_character_2_heal}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_character_2_heal_temp}
                }
                80 = {
                    
                }
            }
        }
        if = {
            limit = {
                check_variable = {FIA_character_2_skill = 4} #反击
            }
            random_list = {
                25 = {
                    if = {
                        limit = {
                            check_variable = {var = FIA_RPG_character_2_ATK_1 value = FIA_RPG_enemy_1_DEF_1 compare = less_than_or_equals}
                        }
                        set_variable = {FIA_character_2_damage = 1}
                    }
                    else = {
                        set_variable = {FIA_character_2_damage = FIA_RPG_character_2_ATK_1}
                        subtract_from_variable = {FIA_character_2_damage = FIA_RPG_enemy_1_DEF_1}
                    }
                    
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_support_4}
                    set_temp_variable = {FIA_character_2_damage_temp = FIA_character_2_damage}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_character_2_damage_temp}

                    subtract_from_variable = {FIA_RPG_enemy_1_HP = FIA_character_2_damage}
                    if  = {
                        limit = {
                            check_variable = {FIA_RPG_enemy_1_HP < 1}
                        }
                        FIA_win_battle_effect = yes
                    }
                }
                75 = {
                }
            }
        }

        if = {
            limit = {
                check_variable = {FIA_character_2_skill = 5} #援护射击 无视一半护甲
            }
            random_list = {
                25 = {
                    set_variable = {FIA_RPG_enemy_1_DEF_1_t = FIA_RPG_enemy_1_DEF_1}
                    multiply_variable = {FIA_RPG_enemy_1_DEF_1_t = 0.5}
                    round_variable = FIA_RPG_enemy_1_DEF_1_t
                    if = {
                        limit = {
                            check_variable = {var = FIA_RPG_character_2_ATK_1 value = FIA_RPG_enemy_1_DEF_1_t compare = less_than_or_equals}
                        }
                        set_variable = {FIA_character_2_damage = 1}
                    }
                    else = {
                        set_variable = {FIA_character_2_damage = FIA_RPG_character_2_ATK_1}
                        subtract_from_variable = {FIA_character_2_damage = FIA_RPG_enemy_1_DEF_1_t}
                    }
                    
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_support_5}
                    set_temp_variable = {FIA_character_2_damage_temp = FIA_character_2_damage}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_character_2_damage_temp}

                    subtract_from_variable = {FIA_RPG_enemy_1_HP = FIA_character_2_damage}
                    if  = {
                        limit = {
                            check_variable = {FIA_RPG_enemy_1_HP < 1}
                        }
                        FIA_win_battle_effect = yes
                    }
                }
                75 = {
                }
            }
        }
    }
}

#敌方行动
FIA_enemy_move_effect = {
    FIA = {
        set_country_flag = FIA_enemy_has_moved
        add_to_variable = { FIA_RPG_enemy_action = 1 }
        if = {
            limit = {
                has_country_flag = FIA_enemy_type_1 #物理敌人
            }
            FIA_enemy_type_1_move_effect = yes
        }
        if = {
            limit = {
                has_country_flag = FIA_enemy_type_2 #魔法敌人
            }
            FIA_enemy_type_2_move_effect = yes
        }
        if = {
            limit = {
                has_country_flag = FIA_enemy_type_3 #双修敌人
            }
            FIA_enemy_type_3_move_effect = yes
        }
        
        FIA_check_if_end_turn = yes
    }
}
FIA_enemy_type_1_move_effect = {
    FIA = {
        set_variable = {FIA_RPG_enemy_damage = 0}
        random_list  = {
            #发动技能
            40 = {
                set_variable = {FIA_RPG_enemy_1_ATK_1_t = FIA_RPG_enemy_1_ATK_1}
                multiply_variable = {FIA_RPG_enemy_1_ATK_1_t = 1.3} #物理技能威力为基础1.3倍
                round_variable = FIA_RPG_enemy_1_ATK_1_t
                if = {
                    limit = {
                        check_variable = {var = FIA_RPG_enemy_1_ATK_1_t value = FIA_RPG_character_1_DEF_1 compare = less_than_or_equals}
                    }
                    set_variable = {FIA_RPG_enemy_damage = 1} #保底伤害
                }
                else = {
                    set_variable = {FIA_RPG_enemy_damage = FIA_RPG_enemy_1_ATK_1_t}
                    subtract_from_variable = {FIA_RPG_enemy_damage = FIA_RPG_character_1_DEF_1}
                }
                FIA_set_enemy_damage_to_random_effect = yes#0.75-1.25随机化，取整
                random_list = {
                    #5%暴击率
                    5 = {
                        multiply_variable = {FIA_RPG_enemy_damage = 2}
                        round_variable = FIA_RPG_enemy_damage
                        set_variable = {FIA_enemy_damage_var = 5}
                        
                    }
                    95 = {
                        set_variable = {FIA_enemy_damage_var = 1}
                    }
                }
                
                
            }
            #普攻
            60 = {
                if = {
                    limit = {
                        check_variable = {var = FIA_RPG_enemy_1_ATK_1 value = FIA_RPG_character_1_DEF_1 compare = less_than_or_equals}
                    }
                    set_variable = {FIA_RPG_enemy_damage = 1} #保底伤害
                }
                else = {
                    set_variable = {FIA_RPG_enemy_damage = FIA_RPG_enemy_1_ATK_1}
                    subtract_from_variable = {FIA_RPG_enemy_damage = FIA_RPG_character_1_DEF_1}
                }
                FIA_set_enemy_damage_to_random_effect = yes#0.75-1.25随机化，取整
                random_list = {
                    #5%暴击率
                    5 = {
                        multiply_variable = {FIA_RPG_enemy_damage = 2}
                        round_variable = FIA_RPG_enemy_damage
                        set_variable = {FIA_enemy_damage_var = 6}
                    }
                    95 = {
                        set_variable = {FIA_enemy_damage_var = 2}
                    }
                }
                
            }
        }
        
        FIA_character_2_skill_effect_1 = yes #检测援护防御，敌方攻击包含
        #FIA_enemy_damage_effect = yes #敌方攻击

    }
}
FIA_enemy_type_2_move_effect = {
    FIA = {
        set_variable = {FIA_RPG_enemy_damage = 0}
        #发动技能
        set_variable = {FIA_RPG_enemy_1_ATK_2_t = FIA_RPG_enemy_1_ATK_2}
        multiply_variable = {FIA_RPG_enemy_1_ATK_2_t = 1.5} #魔法技能威力为基础1.5倍
        round_variable = FIA_RPG_enemy_1_ATK_2_t
        if = {
            limit = {
                OR = {
                    check_variable = {var = FIA_RPG_enemy_1_ATK_2_t value = FIA_RPG_character_1_DEF_2 compare = less_than_or_equals}
                }
            }
            set_variable = {FIA_RPG_enemy_damage = 1} #保底伤害
        }
        else = {
            set_variable = {FIA_RPG_enemy_damage = FIA_RPG_enemy_1_ATK_2_t}
            subtract_from_variable = {FIA_RPG_enemy_damage = FIA_RPG_character_1_DEF_2}
        }
        FIA_set_enemy_damage_to_random_effect = yes#0.75-1.25随机化，取整
        random_list = {
            #5%暴击率
            5 = {
                multiply_variable = {FIA_RPG_enemy_damage = 2}
                round_variable = FIA_RPG_enemy_damage
                set_variable = {FIA_enemy_damage_var = 7}
                
            }
            95 = {
                set_variable = {FIA_enemy_damage_var = 3}
            }
        }
        
        #FIA_character_2_skill_effect_1 = yes #只能抵挡物理伤害
        FIA_enemy_damage_effect = yes #敌方攻击
    }
}
FIA_enemy_type_3_move_effect = {
    FIA = {
        random_list = {
            50 = {
                FIA_enemy_type_1_move_effect = yes
            }
            50 = {
                FIA_enemy_type_2_move_effect = yes
            }
        }
    }
}
#我方攻击执行前检测
FIA_enemy_2_skill_effect_1 = {
    FIA = {
        if = {
            limit = {
                check_variable = {FIA_enemy_2_action = 1} #援护防御
            }
            random_list = {
                20 = {
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_enemy_support_1}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = 0}
                    FIA_check_if_end_turn = yes
                }
                80 = {
                    FIA_character_damage_effect = yes
                }
            }
        }
        else = {
            FIA_character_damage_effect = yes
        }
    }
}
#我方攻击执行后检测
FIA_enemy_2_skill_effect_2 = {
    FIA = {
        if = {
            limit = {
                check_variable = {FIA_enemy_2_action = 2} #治愈
            }
            random_list = {
                20 = {
                    set_variable = {FIA_enemy_2_heal = FIA_RPG_enemy_2_ATK_2}
                    multiply_variable = {FIA_enemy_2_heal = 2}
                    add_to_variable = {FIA_RPG_enemy_1_HP = FIA_enemy_2_heal}
                    round_variable = FIA_RPG_enemy_1_HP
                    clamp_variable = {
                        var = FIA_RPG_enemy_1_HP
                        max = FIA_RPG_enemy_1_MAX_HP
                    }

                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_enemy_support_2}
                    set_temp_variable = {FIA_enemy_2_heal_temp = FIA_enemy_2_heal}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_enemy_2_heal_temp}
                }
                80 = {
                    
                }
            }
        }
        if = {
            limit = {
                check_variable = {FIA_enemy_2_action = 3} #反击
            }
            random_list = {
                25 = {
                    if = {
                        limit = {
                            check_variable = {var = FIA_RPG_enemy_2_ATK_1 value = FIA_RPG_character_1_DEF_1 compare = less_than_or_equals}
                        }
                        set_variable = {FIA_enemy_2_damage = 1}
                    }
                    else = {
                        set_variable = {FIA_enemy_2_damage = FIA_RPG_enemy_2_ATK_1}
                        subtract_from_variable = {FIA_enemy_2_damage = FIA_RPG_character_1_DEF_1}
                    }
                    
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_enemy_support_3}
                    set_temp_variable = {FIA_enemy_2_damage_temp = FIA_enemy_2_damage}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_enemy_2_damage_temp}

                    subtract_from_variable = {FIA_RPG_character_1_HP = FIA_enemy_2_damage}
                    if  = {
                        limit = {
                            check_variable = {FIA_RPG_character_1_HP < 1}
                        }
                        FIA_lose_battle_effect = yes
                    }
                }
                75 = {
                }
            }
        }
        if = {
            limit = {
                check_variable = {FIA_enemy_2_action = 4} #援护射击
            }
            random_list = {
                25 = {
                    set_variable = {FIA_RPG_character_1_DEF_1_t = FIA_RPG_character_1_DEF_1}
                    multiply_variable = {FIA_RPG_character_1_DEF_1_t = 0.5}
                    round_variable = FIA_RPG_character_1_DEF_1_t
                    if = {
                        limit = {
                            check_variable = {var = FIA_RPG_enemy_2_ATK_1 value = FIA_RPG_character_1_DEF_1_t compare = less_than_or_equals}
                        }
                        set_variable = {FIA_enemy_2_damage = 1}
                    }
                    else = {
                        set_variable = {FIA_enemy_2_damage = FIA_RPG_enemy_2_ATK_1}
                        subtract_from_variable = {FIA_enemy_2_damage = FIA_RPG_character_1_DEF_1_t}
                    }
                    
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_enemy_support_3}
                    set_temp_variable = {FIA_enemy_2_damage_temp = FIA_enemy_2_damage}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_enemy_2_damage_temp}

                    subtract_from_variable = {FIA_RPG_character_1_HP = FIA_enemy_2_damage}
                    if  = {
                        limit = {
                            check_variable = {FIA_RPG_character_1_HP < 1}
                        }
                        FIA_lose_battle_effect = yes
                    }
                }
                75 = {
                }
            }
        }
    }
}
#获得经验
FIA_gain_XP_effect = {
    FIA = {
        set_variable = {FIA_XP = 200}
        multiply_variable = {FIA_XP = FIA_enemy_LV}
        meta_effect = {
            text = {
                add_to_variable = {[CHARACTER]_XP = FIA_XP}
                add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_gain_xp_1}
                set_temp_variable = {FIA_RPG_xp_temp = FIA_XP}
                add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_xp_temp}

                set_variable = {FIA_RPG_character_1_LV = [CHARACTER]_LV}
                set_variable = {FIA_RPG_character_1_XP = [CHARACTER]_XP}
                set_variable = {FIA_RPG_character_1_XP_required = [CHARACTER]_XP_required}

                while_loop_effect = {
                    limit = {
                        check_variable = {var = [CHARACTER]_XP value = [CHARACTER]_XP_required compare = greater_than_or_equals}
                    }
                    subtract_from_variable = {[CHARACTER]_XP = [CHARACTER]_XP_required}
                    add_to_variable = {[CHARACTER]_LV = 1}
                    multiply_variable = {[CHARACTER]_XP_required = 1.05}
                    round_variable = [CHARACTER]_XP_required
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_upgrade}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = [CHARACTER_TOKEN]}

                    set_variable = {FIA_character_to_upgrade = [CHARACTER_TOKEN]}
                    FIA_upgrade_effect = yes

                    set_variable = {FIA_RPG_character_1_LV = [CHARACTER]_LV}
                    set_variable = {FIA_RPG_character_1_XP = [CHARACTER]_XP}
                    set_variable = {FIA_RPG_character_1_XP_required = [CHARACTER]_XP_required}
                }
            }
            CHARACTER = "[?FIA_character_to_gain_XP.GetTokenKey]"
            CHARACTER_TOKEN = "[?FIA_character_to_gain_XP]"
        }
    }
}
#获得经验
FIA_gain_XP_sub_effect = {
    FIA = {
        set_variable = {FIA_XP = 10}
        multiply_variable = {FIA_XP = FIA_enemy_LV}
        meta_effect = {
            text = {
                add_to_variable = {[CHARACTER]_XP = FIA_XP}
                add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_gain_xp_2}
                set_temp_variable = {FIA_RPG_xp_temp = FIA_XP}
                add_to_array = {FIA_RPG_GAME_record_Array_2 = FIA_RPG_xp_temp}
                
                while_loop_effect = {
                    limit = {
                        check_variable = {var = [CHARACTER]_XP value = [CHARACTER]_XP_required compare = greater_than_or_equals}
                    }
                    subtract_from_variable = {[CHARACTER]_XP = [CHARACTER]_XP_required}
                    add_to_variable = {[CHARACTER]_LV = 1}
                    multiply_variable = {[CHARACTER]_XP_required = 1.05}

                    set_variable = {FIA_character_to_upgrade = [CHARACTER_TOKEN]}
                    FIA_upgrade_effect = yes

                    round_variable = [CHARACTER]_XP_required
                    add_to_array = {FIA_RPG_GAME_record_Array = token:FIA_log_upgrade}
                    add_to_array = {FIA_RPG_GAME_record_Array_2 = [CHARACTER_TOKEN]}
                }
            }
            CHARACTER = "[?FIA_sub_character_to_gain_XP.GetTokenKey]"
            CHARACTER_TOKEN = "[?FIA_sub_character_to_gain_XP]"
        }
    }
}


#升级效果
FIA_upgrade_effect = {
    FIA = {
        meta_effect = {
            text = {
                add_to_variable = {[CHARACTER]_MAX_HP = 1}
                random_list = {
                    50 = {
                        add_to_variable = {[CHARACTER]_ATK_1 = 1}
                    }
                    50 = {
                        add_to_variable = {[CHARACTER]_ATK_2 = 1}
                    }
                }
                random_list = {
                    50 = {
                        add_to_variable = {[CHARACTER]_DEF_1 = 1}
                    }
                    50 = {
                        add_to_variable = {[CHARACTER]_DEF_2 = 1}
                    }
                }
                random_list = {
                    40 = {
                        add_to_variable = {[CHARACTER]_MAX_HP = 1}
                    }
                    20 = {
                        add_to_variable = {[CHARACTER]_SPEED = 1}
                    }
                    40 = {}
                }
            }
            CHARACTER = "[?FIA_character_to_upgrade.GetTokenKey]"
        }
        FIA_refresh_character_1_data_effect = yes
    }
}

#创建测试用敌人
FIA_demo_enemy_effect = {
    FIA = {
        set_country_flag = FIA_is_in_battle
        set_country_flag = FIA_enemy_type_1
        set_variable = {FIA_enemy_var = 100}
        set_variable = {FIA_enemy_LV = 1}
        set_variable = {FIA_RPG_enemy_1_MAX_HP = 10}
        set_variable = {FIA_RPG_enemy_1_HP = FIA_RPG_enemy_1_MAX_HP}
        set_variable = {FIA_RPG_enemy_1_ATK_1 = 1}
        set_variable = {FIA_RPG_enemy_1_ATK_2 = 1}
        set_variable = {FIA_RPG_enemy_1_DEF_1 = 1}
        set_variable = {FIA_RPG_enemy_1_DEF_2 = 1}
        set_variable = {FIA_RPG_enemy_1_SPEED = 10}
        set_variable = {FIA_enemy_1_race_var = 1}
        set_variable = {FIA_enemy_1_special_var = 1}

        set_variable = {FIA_enemy_2_var = 1}
        set_variable = {FIA_RPG_enemy_2_ATK_1 = 1}
        set_variable = {FIA_RPG_enemy_2_ATK_2 = 1}
        set_variable = {FIA_RPG_enemy_2_DEF_1 = 1}
        set_variable = {FIA_RPG_enemy_2_DEF_2 = 1}
        set_variable = {FIA_enemy_2_action = 1}
    }
}

#创建测试用敌人
FIA_demo_enemy_effect_2 = {
    FIA = {
        set_country_flag = FIA_is_in_battle
        set_country_flag = FIA_enemy_type_1
        set_variable = {FIA_enemy_var = 100}
        set_variable = {FIA_enemy_LV = 1}
        set_variable = {FIA_RPG_enemy_1_MAX_HP = 10}
        set_variable = {FIA_RPG_enemy_1_HP = FIA_RPG_enemy_1_MAX_HP}
        set_variable = {FIA_RPG_enemy_1_ATK_1 = 1}
        set_variable = {FIA_RPG_enemy_1_ATK_2 = 1}
        set_variable = {FIA_RPG_enemy_1_DEF_1 = 1}
        set_variable = {FIA_RPG_enemy_1_DEF_2 = 1}
        set_variable = {FIA_RPG_enemy_1_SPEED = 1}
        set_variable = {FIA_enemy_1_race_var = 1}
        set_variable = {FIA_enemy_1_special_var = 1}

        set_variable = {FIA_enemy_2_var = 1}
        set_variable = {FIA_RPG_enemy_2_ATK_1 = 1}
        set_variable = {FIA_RPG_enemy_2_ATK_2 = 1}
        set_variable = {FIA_RPG_enemy_2_DEF_1 = 1}
        set_variable = {FIA_RPG_enemy_2_DEF_2 = 1}
        set_variable = {FIA_enemy_2_action = 1}
    }
}